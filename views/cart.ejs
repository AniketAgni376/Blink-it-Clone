<%- include('./partials/header'); %>

    <body class="bg-gray-100 font-sans">
        <div class="max-w-screen-md mx-auto p-4">
            <!-- Header -->
            <div class="flex justify-between items-center py-4">
                <button class="text-lg"><i class="ri-arrow-left-s-line"></i></button>
                <h1 class="text-xl font-semibold">Checkout</h1>
                <button class="text-lg">Share</button>
            </div>

            <!-- Delivery Info -->
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <div class="flex items-center gap-4">
                    <i
                        class="w-10 h-10 flex items-center justify-center rounded bg-zinc-100 text-2xl ri-timer-line"></i>
                    <div>
                        <p class="text-sm font-medium">Delivery in <%= Math.floor((Math.random()*10)+3) %> minutes</p>
                        <p class="text-xs text-gray-500">Shipment of 1 item</p>
                    </div>
                </div>
                <div id="cart-items">
                <% cart.forEach(elem=> { %>
                    <div class="flex items-center mt-4">
                        <img src="data:image/jpg;base64, <%= elem.image.toString('base64') %>" alt="<%= elem.name %>"
                            class="w-16 h-16 rounded">
                        <div class="ml-4">
                            <p>
                                <%= elem.name %>
                            </p>
                            <p class="text-xs text-gray-500">170 g</p>
                        </div>
                        <div class="ml-auto">
                            <div class="flex items-center justify-center bg-green-700 text-white rounded-md">
                                <button class="cart-decrement px-2 py-1 rounded" data-id="<%= elem._id %>"><i class="ri-subtract-line"></i></button>
                                <p class="mx-2 quantity" data-id="<%= elem._id %>">
                                    <%= elem.quantity %>
                                </p>
                                <button class="cart-increment px-2 py-1 rounded" data-id="<%= elem._id %>"><i class="ri-add-line"></i></button>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <p class="text-gray-500 line-through item-strike" data-id="<%= elem._id %>" data-price="<%= Number(elem.price) %>">₹<%= Number(elem.price)*Number(elem.quantity)+20
                                        %>
                                </p>
                                <p class="item-total" data-id="<%= elem._id %>" data-price="<%= Number(elem.price) %>">₹<%= Number(elem.price)*Number(elem.quantity)%>
                                </p>
                            </div>
                        </div>
                    </div>
                    <% })%>
                </div>
            </div>

            <!-- Before You Checkout -->
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-semibold">Before you checkout</h2>
                <div class="flex space-x-4 mt-4">
                    <% if (suggestedProducts && suggestedProducts.length > 0) { %>
                        <% suggestedProducts.forEach(function(product) { %>
                            <div class="flex flex-col items-center">
                                <img src="data:image/jpg;base64, <%= product.image ? product.image.toString('base64') : '' %>"
                                    alt="<%= product.name %>" class="h-24 rounded">
                                <p class="text-sm text-center mt-2"><%= product.name %></p>
                                <button class="add-suggested-product bg-green-700 text-white px-4 py-1 rounded mt-2" data-id="<%= product._id %>">ADD</button>
                                <p class="text-xs mt-2">₹<%= product.price %></p>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <!-- Fallback if no suggested products -->
                        <p class="text-sm text-gray-500">No suggested products available</p>
                    <% } %>
                </div>
                <div class="mt-4 text-center text-white bg-green-700 py-5 px-10 rounded-md">
                    <h1 class="text-xl font-semibold">Get FREE delivery</h1>
                    <p class="text-xs">Add products worth ₹236 more</p>
                    <button
                        class="text-sm bg-zinc-200 text-black px-10 py-3 rounded-xl font-semibold capitalize mt-6">See
                        all coupons</button>
                </div>
            </div>

            <!-- Bill Details -->
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-semibold">Bill details</h2>
                <div class="mt-2">
                    <div class="flex justify-between">
                        <p class="text-sm">Items total</p>
                        <p id="items-total" class="text-sm">₹<%= finalprice - 34 %>
                        </p>
                    </div>
                    <div class="flex justify-between">
                        <p class="text-sm">Delivery charge</p>
                        <p class="text-sm">₹30</p>
                    </div>
                    <div class="flex justify-between">
                        <p class="text-sm">Handling charge</p>
                        <p class="text-sm">₹4</p>
                    </div>
                    <div class="flex justify-between font-bold mt-2">
                        <p class="text-lg">Grand total</p>
                        <p id="grand-total" class="text-lg">₹<%= finalprice %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Donation -->
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <div class="flex items-center">
                    <img src="https://b.zmtcdn.com/data/fi_assets/9fbf0569f69bfef7d190c5b892ab0a521619355737.png"
                        alt="Feeding India" class="w-12 h-12 rounded">
                    <div class="ml-4">
                        <p class="font-semibold">Feeding India donation</p>
                        <p class="text-sm opacity-50">Working towards a malnutrition free India. Feeding India...<span
                                class="text-blue-500">read more</span></p>
                    </div>
                    <p class="ml-auto text-sm font-bold">₹1</p>
                </div>
            </div>

            <!-- Delivery Instructions -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold">Delivery instructions</h2>
                <div class="flex space-x-4 mt-4">
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-mic-line"></i>
                        <p class="text-sm">Record</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-prohibited-line"></i>
                        <p class="leading-none text-sm">Avoid calling</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-notification-off-line"></i>
                        <p class="text-sm">Don't ring the bell</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-door-open-line"></i>
                        <p class="text-sm">Leave at door</p>
                    </button>
                </div>
            </div>

            <!-- Ordering for someone else -->
            <div class="bg-white p-4 rounded-lg shadow mt-10">Ordering for someone else? Add details</div>
            <!-- Cancellation Policy -->
            <div class="bg-white p-4 rounded-lg shadow mb-40 mt-10">
                <p class="text-sm">
                    Orders cannot be cancelled once packed for delivery. In case of unexpected delays, a refund will be
                    provided, if applicable.
                </p>
            </div>

            <!-- Footer -->
            <div class="bg-white p-4 rounded-lg shadow fixed bottom-0 inset-x-0">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm">Delivering to Home</p>
                        <p class="text-xs text-gray-500">1st Floor M2, 132C Apex Builders Sector C Indrauri, saarthi...
                        </p>
                    </div>
                    <button class="text-blue-500">Change</button>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <div>
                        <p class="text-sm">PAY USING</p>
                        <p class="text-xs text-gray-500">Paytm UPI</p>
                    </div>
                    <div>
                        <p id="footer-total" class="text-lg font-bold">₹<%= finalprice %>
                        </p>
                        <button class="paybtn bg-green-700 text-white px-4 py-2 rounded" style="<%= finalprice > 0 ? '' : 'display:none' %>">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            function formatINR(num) {
                return '₹' + num;
            }

            async function call(endpoint) {
                return fetch(endpoint, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            }

            function recomputeTotals() {
                let subtotal = 0;
                document.querySelectorAll('.item-total').forEach(function (el) {
                    const id = el.getAttribute('data-id');
                    const unit = Number(el.getAttribute('data-price')) || 0;
                    const qtyEl = document.querySelector(`.quantity[data-id="${id}"]`);
                    const qty = qtyEl ? (parseInt(qtyEl.textContent) || 0) : 0;
                    subtotal += unit * qty;
                });
                const itemsTotalEl = document.getElementById('items-total');
                const grandTotalEl = document.getElementById('grand-total');
                const footerTotalEl = document.getElementById('footer-total');
                const payBtn = document.querySelector('.paybtn');
                // Only add delivery and handling charges (₹34) if there are items in cart
                const finalTotal = subtotal > 0 ? subtotal + 34 : 0;
                if (itemsTotalEl) itemsTotalEl.textContent = formatINR(subtotal);
                if (grandTotalEl) grandTotalEl.textContent = formatINR(finalTotal);
                if (footerTotalEl) footerTotalEl.textContent = formatINR(finalTotal);
                if (payBtn) payBtn.style.display = finalTotal > 0 ? '' : 'none';
            }

            document.addEventListener('click', async function (e) {
                const inc = e.target.closest('.cart-increment');
                const dec = e.target.closest('.cart-decrement');
                const btn = inc || dec;
                if (!btn) return;
                e.preventDefault();

                const id = btn.getAttribute('data-id');
                const quantityEl = document.querySelector(`.quantity[data-id="${id}"]`);
                const row = btn.closest('.flex.items-center.mt-4');

                try {
                    if (inc) await call(`/cart/add/${id}`);
                    else await call(`/cart/remove/${id}`);

                    let qty = parseInt(quantityEl.textContent) || 0;
                    qty = inc ? qty + 1 : Math.max(0, qty - 1);
                    quantityEl.textContent = qty;

                    // Update item totals if present
                    const priceEl = row.querySelector('.item-total');
                    const strikeEl = row.querySelector('.item-strike');
                    if (priceEl) {
                        const unit = Number(priceEl.getAttribute('data-price')) || 0;
                        priceEl.textContent = formatINR(unit * qty);
                    }
                    if (strikeEl) {
                        const unit = Number(strikeEl.getAttribute('data-price')) || 0;
                        strikeEl.textContent = formatINR(unit * qty + 20);
                    }

                    // Remove row if qty is 0
                    if (qty === 0 && row) row.remove();

                    // Recompute totals after any change
                    recomputeTotals();
                } catch (err) {
                    console.error(err);
                }
            });

            // Sync totals on initial load to avoid any server-render mismatch
            document.addEventListener('DOMContentLoaded', function () {
                recomputeTotals();
            });

            // Handle suggested product add buttons without full page reload
            document.addEventListener('click', async function (e) {
                const btn = e.target.closest('.add-suggested-product');
                if (!btn) return;
                e.preventDefault();

                const id = btn.getAttribute('data-id');
                // Try to find an existing cart row for this product
                const existingQtyEl = document.querySelector(`.quantity[data-id="${id}"]`);
                const itemsContainer = document.getElementById('cart-items');

                // Pull minimal data from the suggested product card
                const card = btn.closest('.flex.flex-col.items-center');
                const imgSrc = card ? card.querySelector('img')?.getAttribute('src') || '' : '';
                const nameText = card ? (card.querySelector('p.text-sm.text-center.mt-2')?.textContent || '') : '';
                const priceText = card ? (card.querySelector('p.text-xs.mt-2')?.textContent || '').replace(/[^0-9]/g, '') : '0';
                const unitPrice = Number(priceText) || 0;

                // Optimistic UI: disable button while processing
                btn.disabled = true;
                try {
                    await call(`/cart/add/${id}`);

                    if (existingQtyEl) {
                        // If already present in cart, just bump qty and recompute totals
                        let qty = parseInt(existingQtyEl.textContent) || 0;
                        qty += 1;
                        existingQtyEl.textContent = qty;

                        const row = existingQtyEl.closest('.flex.items-center.mt-4');
                        const priceEl = row?.querySelector('.item-total');
                        const strikeEl = row?.querySelector('.item-strike');
                        if (priceEl) {
                            const unit = Number(priceEl.getAttribute('data-price')) || unitPrice;
                            priceEl.textContent = formatINR(unit * qty);
                        }
                        if (strikeEl) {
                            const unit = Number(strikeEl.getAttribute('data-price')) || unitPrice;
                            strikeEl.textContent = formatINR(unit * qty + 20);
                        }
                    } else if (itemsContainer && unitPrice > 0) {
                        // Create a new cart row if it doesn't exist yet
                        const wrapper = document.createElement('div');
                        wrapper.className = 'flex items-center mt-4';
                        wrapper.innerHTML = `
                            <img src="${imgSrc}" alt="${nameText}" class="w-16 h-16 rounded">
                            <div class="ml-4">
                                <p>${nameText}</p>
                                <p class="text-xs text-gray-500">170 g</p>
                            </div>
                            <div class="ml-auto">
                                <div class="flex items-center justify-center bg-green-700 text-white rounded-md">
                                    <button class="cart-decrement px-2 py-1 rounded" data-id="${id}"><i class="ri-subtract-line"></i></button>
                                    <p class="mx-2 quantity" data-id="${id}">1</p>
                                    <button class="cart-increment px-2 py-1 rounded" data-id="${id}"><i class="ri-add-line"></i></button>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <p class="text-gray-500 line-through item-strike" data-id="${id}" data-price="${unitPrice}">${formatINR(unitPrice + 20)}</p>
                                    <p class="item-total" data-id="${id}" data-price="${unitPrice}">${formatINR(unitPrice)}</p>
                                </div>
                            </div>
                        `;
                        itemsContainer.appendChild(wrapper);
                    }

                    // Recompute totals after any change
                    recomputeTotals();
                } catch (err) {
                    console.error(err);
                } finally {
                    btn.disabled = false;
                }
            });
        </script>
        <script>
            document.querySelector('.paybtn').onclick = function (e) {
                axios.post('/payment/create/orderId')
                    .then(function (response) {
                        var options = {
                            "key": "rzp_test_RbOOoQF3OBQp6a", // Enter the Key ID generated from the Dashboard
                            "amount": response.data.amount, // Amount in currency subunits. Default currency is INR.
                            "currency": response.data.currency,
                            "name": "BlinkIt",
                            "description": "Test Transaction",
                            "image": "https://example.com/your_logo",
                            "order_id": response.data.id,
                            "handler": function (response) {
                                axios.post('/payment/api/payment/verify', {
                                    razorpayOrderId: response.razorpay_order_id,
                                    razorpayPaymentId: response.razorpay_payment_id,
                                    signature: response.razorpay_signature
                                })
                                    .then(function (response) {
                                        let { razorpayOrderId, razorpayPaymentId, signature } = JSON.parse(response.config.data)
                                        window.location.href = `/order/<%= userid %>/${razorpayOrderId}/${razorpayPaymentId}/${signature}`
                                    })
                                    .catch(function (error) {
                                        console.error(error);
                                    });
                            },
                            "prefill": {
                                "name": "Aniket Agnihotri",
                                "email": "aniket@example.com",
                                "contact": "9000090000"
                            },
                            "notes": {
                                "address": "Razorpay Corporate Office"
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        var rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response) {
                            alert('Payment Failed');
                            alert('Error Code: ' + response.error.code);
                            alert('Description: ' + response.error.description);
                            alert('Source: ' + response.error.source);
                            alert('Step: ' + response.error.step);
                            alert('Reason: ' + response.error.reason);
                            alert('Order ID: ' + response.error.metadata.order_id);
                            alert('Payment ID: ' + response.error.metadata.payment_id);
                        });
                        rzp1.open();
                        e.preventDefault();
                    })
                    .catch(function (error) {
                        console.error(error);
                    });
            };
        </script>
    </body>

    <%- include('./partials/footer'); %>